#!/usr/bin/env bash
set -euo pipefail

# Block accidental image changes in common image directories.
# Allow by setting ALLOW_IMAGE_CHANGES=1 for intentional updates.

# Collect staged files (Added, Copied, Modified, Renamed, Type changed)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMRT || true)

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

# Match images under typical paths
IMAGE_RE='(^public/images/|^src/assets/images/).+\.(png|jpg|jpeg|webp|avif|gif|svg)$'

CHANGED_IMAGES=$(printf '%s\n' "$STAGED_FILES" | grep -E -i "$IMAGE_RE" || true)

if [ -n "$CHANGED_IMAGES" ] && [ "${ALLOW_IMAGE_CHANGES:-}" != "1" ]; then
  echo "\n✖ Image changes detected in staged files:" >&2
  printf '  - %s\n' $CHANGED_IMAGES >&2
  echo "\nThis commit has been blocked to prevent accidental asset swaps." >&2
  echo "If this is intentional, run one of the following:" >&2
  echo "  ALLOW_IMAGE_CHANGES=1 git commit -m 'update images'" >&2
  echo "  git commit --no-verify   # bypass hook (not recommended)" >&2
  exit 1
fi

if [ -n "$CHANGED_IMAGES" ]; then
  echo "✓ Allowing image changes (ALLOW_IMAGE_CHANGES=1 detected)"
fi

exit 0

